<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KubeViewer - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=20251215b">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-node-html-label@1.2.2/dist/cytoscape-node-html-label.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon small"></div>
                <h2>KubeViewer</h2>
            </div>

            <div class="cluster-selector-container">
                <label>Cluster</label>
                <select id="clusterSelect" class="cluster-select">
                    <!-- Clusters injected here -->
                </select>
                <div class="cluster-upload" id="clusterUpload">
                    <button type="button" class="cluster-upload-toggle" id="clusterUploadToggle" aria-expanded="false">
                        <div class="cluster-upload-info">
                            <h4>Connect Cluster</h4>
                            <p>Upload a kubeconfig to quickly switch environments.</p>
                        </div>
                        <span class="cluster-upload-chevron" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M6 9l6 6 6-6"></path>
                            </svg>
                        </span>
                    </button>
                    <div class="cluster-upload-body" id="clusterUploadBody">
                        <label for="kubeconfigFile" class="file-upload">
                            <span class="file-upload-button">Dosya Se√ß</span>
                            <span class="file-upload-name" id="kubeconfigFileName">Dosya se√ßilmedi</span>
                        </label>
                        <input type="file" id="kubeconfigFile" accept=".yaml,.yml,.conf,.json,.txt">
                        <input type="text" id="kubeconfigName" placeholder="Cluster name (optional)">
                        <input type="text" id="kubeconfigContext" placeholder="Context (optional)">
                        <label class="checkbox-row" for="kubeconfigInsecure">
                            <input type="checkbox" id="kubeconfigInsecure">
                            <span>Insecure (TLS doƒürulamasƒ±nƒ± atla)</span>
                        </label>
                        <button type="button" id="uploadKubeconfigBtn" class="upload-btn">Add Cluster</button>
                        <div id="uploadStatus" class="upload-status" aria-live="polite"></div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-header">Views</div>
                    <a href="#" class="nav-item active" data-type="maturity">Maturity Analysis</a>
                    <a href="#" class="nav-item topology-nav" data-type="topology">Topology Graph</a>
                    <a href="#" class="nav-item create-nav" data-type="create">‚ûï Create Resource</a>
                </div>

                <div class="nav-group">
                    <div class="nav-header">Workloads</div>
                    <a href="#" class="nav-item" data-type="pod">Pods</a>
                    <a href="#" class="nav-item" data-type="deployment">Deployments</a>
                    <a href="#" class="nav-item" data-type="statefulset">StatefulSets</a>
                    <a href="#" class="nav-item" data-type="replicaset">ReplicaSets</a>
                    <a href="#" class="nav-item" data-type="daemonset">DaemonSets</a>
                    <a href="#" class="nav-item" data-type="job">Jobs</a>
                    <a href="#" class="nav-item" data-type="cronjob">CronJobs</a>
                </div>

                <div class="nav-group">
                    <div class="nav-header">Storage</div>
                    <a href="#" class="nav-item" data-type="pvc">PVCs</a>
                    <a href="#" class="nav-item" data-type="configmap">ConfigMaps</a>
                    <a href="#" class="nav-item" data-type="secret">Secrets</a>
                </div>

                <div class="nav-group">
                    <div class="nav-header">Network</div>
                    <a href="#" class="nav-item" data-type="service">Services</a>
                    <a href="#" class="nav-item" data-type="ingress">Ingress</a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="breadcrumbs">
                    <span id="crumbCluster">default</span>
                    <span class="separator">/</span>
                    <span id="crumbResource">Pods</span>
                </div>

                <div class="top-controls">
                    <select id="nsSelect" class="namespace-select">
                        <option value="all">All Namespaces</option>
                    </select>
                    <button id="refreshBtn" class="action-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                </div>
            </header>

            <div class="content-body" id="analysisView">
                <div class="maturity-shell">
                    <div class="maturity-topbar">
                        <div class="maturity-titleblock">
                            <h2 class="maturity-title">Cluster Olgunluk Analizi</h2>
                            <div class="maturity-subtitle">`test.md` rubric + cluster kanƒ±tƒ± + (opsiyonel) LLM deƒüerlendirmesi.</div>
                        </div>
                        <div class="maturity-actions">
                            <button id="loadCriteriaBtn" class="maturity-btn">Reload</button>
                            <button id="downloadPdfBtn" class="maturity-btn">PDF</button>
                            <button id="clearMaturityBtn" class="maturity-btn">Temizle</button>
                            <button id="runMaturityBtn" class="maturity-btn primary">Analyze</button>
                        </div>
                    </div>

                    <div class="maturity-shell-body">
                        <section class="maturity-main">
                            <div class="maturity-toolbar">
                                <div class="maturity-search">
                                    <input id="maturitySearch" class="maturity-input" type="text" placeholder="Kriter ara (√∂rn: RBAC, NetworkPolicy, Backup)">
                                </div>
                                <div class="maturity-toolbar-actions">
                                    <button id="loadEvidenceBtn" class="maturity-btn">Evidence</button>
                                </div>
                            </div>

                            <div id="maturityResults" class="maturity-results"></div>
                        </section>

                        <aside class="maturity-side">
                            <div class="maturity-panel">
                                <div class="maturity-panel-header">
                                    <h3>√ñzet</h3>
                                    <div id="maturityOverallBadge" class="maturity-badge">‚Äî</div>
                                </div>
                                <div id="maturitySummary" class="maturity-summary"></div>
                            </div>

                            <div class="maturity-panel">
                                <div class="maturity-panel-header">
                                    <h3>LLM Ayarlarƒ±</h3>
                                </div>
                                <div class="maturity-llm-grid">
                                    <div class="maturity-field">
                                        <label class="maturity-label" for="llmProvider">Provider</label>
                                        <select id="llmProvider" class="maturity-select">
                                            <option value="auto">Auto</option>
                                            <option value="gemini">Gemini</option>
                                            <option value="openai">OpenAI</option>
                                            <option value="none">None</option>
                                        </select>
                                    </div>
                                    <div class="maturity-field">
                                        <label class="maturity-label" for="llmModel">Model</label>
                                        <input id="llmModel" class="maturity-input" type="text" placeholder="gemini-1.5-flash / gpt-4o-mini">
                                    </div>
                                    <div class="maturity-field">
                                        <label class="maturity-label" for="llmApiKey">API Key</label>
                                        <input id="llmApiKey" class="maturity-input" type="password" placeholder="(sadece bu istek i√ßin)">
                                    </div>
                                </div>
                                <div class="maturity-hint">API key tarayƒ±cƒ±da tutulmaz; sadece bu request ile backend‚Äôe gider.</div>
                            </div>

                            <div class="maturity-panel">
                                <div class="maturity-panel-header">
                                    <h3>Notlar</h3>
                                </div>
                                <textarea id="maturityNotes" class="maturity-notes" placeholder="√ñrn: Control plane mimarisi, backup aracƒ±, GitOps s√ºre√ßleri, RBAC politikalarƒ±..."></textarea>
                            </div>

                            <div id="maturityStatus" class="maturity-status" aria-live="polite"></div>

                            <div class="maturity-panel">
                                <div class="maturity-panel-header">
                                    <h3>Evidence</h3>
                                </div>
                                <div id="maturityEvidence" class="maturity-evidence empty">Hen√ºz y√ºklenmedi.</div>
                            </div>
                        </aside>
                    </div>
                </div>

                <div id="maturityWizard" class="maturity-wizard hidden" role="dialog" aria-modal="true" aria-labelledby="maturityWizardTitle">
                    <div class="maturity-wizard-card">
                        <div class="maturity-wizard-header">
                            <div class="maturity-wizard-titleblock">
                                <h3 id="maturityWizardTitle">√ñn Analiz Sorularƒ±</h3>
                                <div id="maturityWizardSubtitle" class="maturity-wizard-subtitle">Precheck tamamlandƒ±. Eksik/≈ü√ºpheli kriterler i√ßin hƒ±zlƒ± sorular.</div>
                            </div>
                            <button id="maturityWizardClose" class="maturity-btn">Kapat</button>
                        </div>

                        <div class="maturity-wizard-body">
                            <div class="maturity-wizard-step">
                                <div class="maturity-wizard-meta">
                                    <div id="maturityWizardProgress" class="maturity-muted">‚Äî</div>
                                    <div id="maturityWizardLLM" class="maturity-muted"></div>
                                </div>

                                <div id="maturityWizardContent" class="maturity-wizard-content">
                                    <div class="maturity-muted">Sorularƒ± olu≈üturmak i√ßin devam edin.</div>
                                </div>
                            </div>
                        </div>

                        <div class="maturity-wizard-actions">
                            <button id="maturityWizardGenerate" class="maturity-btn">Sorularƒ± Olu≈ütur</button>
                            <button id="maturityWizardSkip" class="maturity-btn">Atla</button>
                            <div class="spacer"></div>
                            <button id="maturityWizardPrev" class="maturity-btn">Geri</button>
                            <button id="maturityWizardNext" class="maturity-btn primary">ƒ∞leri</button>
                            <button id="maturityWizardRun" class="maturity-btn primary hidden">Rapor Olu≈ütur</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-body hidden" id="listView">
                <div class="grid-container" id="resourceGrid">
                    <div class="loading-state">Loading resources...</div>
                </div>

                <div class="events-section">
                    <h3>Events</h3>
                    <div class="events-table-container">
                        <table class="events-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Reason</th>
                                    <th>Object</th>
                                    <th>Message</th>
                                    <th>Age</th>
                                </tr>
                            </thead>
                            <tbody id="eventGrid">
                                <tr>
                                    <td colspan="5" class="loading-cell">Loading events...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="content-body hidden" id="graphView" style="padding:0; overflow:hidden;">
                <div id="cy" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- Create Resource View -->
            <div class="content-body hidden" id="createView" style="padding:0; display: flex;">
                <!-- Left: Form -->
                <div class="create-form-panel">
                    <h2>üõ†Ô∏è Resource Builder</h2>

                    <!-- Workload Section -->
                    <div class="form-section">
                        <h3>üì¶ Workload</h3>
                        <div class="form-row">
                            <label>Type</label>
                            <select id="createWorkloadType">
                                <option value="deployment">Deployment</option>
                                <option value="statefulset">StatefulSet</option>
                                <option value="daemonset">DaemonSet</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Name</label>
                            <input type="text" id="createWorkloadName" placeholder="my-app"
                                oninput="updateCreatePreview()">
                        </div>
                        <div class="form-row">
                            <label>Replicas</label>
                            <input type="number" id="createReplicas" value="1" min="1" oninput="updateCreatePreview()">
                        </div>
                        <div class="form-row">
                            <label>Container Name</label>
                            <input type="text" id="createContainerName" placeholder="main"
                                oninput="updateCreatePreview()">
                        </div>
                        <div class="form-row">
                            <label>Image</label>
                            <input type="text" id="createImage" placeholder="nginx:latest"
                                oninput="updateCreatePreview()">
                        </div>
                        <div class="form-row">
                            <label>Container Port</label>
                            <input type="number" id="createContainerPort" placeholder="80"
                                oninput="updateCreatePreview()">
                        </div>
                    </div>

                    <!-- Environment Variables Section -->
                    <div class="form-section">
                        <h3>üîß Environment Variables</h3>
                        <div id="envVarsList"></div>
                        <button type="button" class="add-btn" onclick="addEnvVar()">+ Add Variable</button>
                    </div>

                    <!-- Resource Limits Section -->
                    <div class="form-section">
                        <h3><input type="checkbox" id="createResourcesEnabled" onchange="updateCreatePreview()"> üìä
                            Resource Limits</h3>
                        <div id="resourceLimitsFields" class="hidden">
                            <div class="form-row">
                                <label>CPU Request</label>
                                <input type="text" id="createCpuRequest" placeholder="100m"
                                    oninput="updateCreatePreview()">
                            </div>
                            <div class="form-row">
                                <label>CPU Limit</label>
                                <input type="text" id="createCpuLimit" placeholder="500m"
                                    oninput="updateCreatePreview()">
                            </div>
                            <div class="form-row">
                                <label>Memory Request</label>
                                <input type="text" id="createMemRequest" placeholder="128Mi"
                                    oninput="updateCreatePreview()">
                            </div>
                            <div class="form-row">
                                <label>Memory Limit</label>
                                <input type="text" id="createMemLimit" placeholder="512Mi"
                                    oninput="updateCreatePreview()">
                            </div>
                        </div>
                    </div>

                    <!-- Service Section -->
                    <div class="form-section">
                        <h3><input type="checkbox" id="createServiceEnabled" onchange="updateCreatePreview()"> ‚ö° Service
                        </h3>
                        <div id="serviceFields" class="hidden">
                            <div class="form-row">
                                <label>Type</label>
                                <select id="createServiceType" onchange="updateCreatePreview()">
                                    <option value="ClusterIP">ClusterIP</option>
                                    <option value="NodePort">NodePort</option>
                                    <option value="LoadBalancer">LoadBalancer</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label>Port</label>
                                <input type="number" id="createServicePort" value="80" oninput="updateCreatePreview()">
                            </div>
                        </div>
                    </div>

                    <!-- Ingress Section -->
                    <div class="form-section">
                        <h3><input type="checkbox" id="createIngressEnabled" onchange="updateCreatePreview()"> üåê
                            Ingress</h3>
                        <div id="ingressFields" class="hidden">
                            <div class="form-row">
                                <label>Host</label>
                                <input type="text" id="createIngressHost" placeholder="app.example.com"
                                    oninput="updateCreatePreview()">
                            </div>
                            <div class="form-row">
                                <label>Path</label>
                                <input type="text" id="createIngressPath" value="/" oninput="updateCreatePreview()">
                            </div>
                            <div class="form-row">
                                <label>Path Type</label>
                                <select id="createIngressPathType">
                                    <option value="Prefix">Prefix</option>
                                    <option value="Exact">Exact</option>
                                    <option value="ImplementationSpecific">ImplementationSpecific</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ConfigMap Section -->
                    <div class="form-section">
                        <h3><input type="checkbox" id="createConfigMapEnabled" onchange="updateCreatePreview()"> üìù
                            ConfigMap</h3>
                        <div id="configMapFields" class="hidden">
                            <div class="form-row">
                                <label>Usage</label>
                                <select id="createConfigMapUsage">
                                    <option value="mount">Mount as Volume</option>
                                    <option value="env">Use as Env Vars</option>
                                </select>
                            </div>
                            <div class="form-row" id="configMapMountRow">
                                <label>Mount Path</label>
                                <input type="text" id="createConfigMapPath" placeholder="/etc/config"
                                    oninput="updateCreatePreview()">
                            </div>
                        </div>
                    </div>

                    <!-- Secret Section -->
                    <div class="form-section">
                        <h3><input type="checkbox" id="createSecretEnabled" onchange="updateCreatePreview()"> üîê Secret
                        </h3>
                        <div id="secretFields" class="hidden">
                            <div class="form-row">
                                <label>Usage</label>
                                <select id="createSecretUsage">
                                    <option value="mount">Mount as Volume</option>
                                    <option value="env">Use as Env Vars</option>
                                </select>
                            </div>
                            <div class="form-row" id="secretMountRow">
                                <label>Mount Path</label>
                                <input type="text" id="createSecretPath" placeholder="/etc/secrets"
                                    oninput="updateCreatePreview()">
                            </div>
                        </div>
                    </div>

                    <!-- PVC Section -->
                    <div class="form-section">
                        <h3><input type="checkbox" id="createPVCEnabled" onchange="updateCreatePreview()"> üíæ PVC</h3>
                        <div id="pvcFields" class="hidden">
                            <div class="form-row">
                                <label>Size</label>
                                <input type="text" id="createPVCSize" placeholder="1Gi" oninput="updateCreatePreview()">
                            </div>
                            <div class="form-row">
                                <label>Access Mode</label>
                                <select id="createPVCAccessMode">
                                    <option value="ReadWriteOnce">ReadWriteOnce (RWO)</option>
                                    <option value="ReadWriteMany">ReadWriteMany (RWX)</option>
                                    <option value="ReadOnlyMany">ReadOnlyMany (ROX)</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label>Mount Path</label>
                                <input type="text" id="createPVCPath" placeholder="/data"
                                    oninput="updateCreatePreview()">
                            </div>
                        </div>
                    </div>

                    <!-- Deploy Button -->
                    <button class="deploy-btn" onclick="deployResources()">üöÄ Deploy</button>
                </div>

                <!-- Right: Live Preview -->
                <div class="create-preview-panel">
                    <h3>Live Preview</h3>
                    <div id="createPreviewCy" style="width: 100%; height: calc(100% - 40px);"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- Detail Panel (Slide-out) -->
    <div id="detailPanel" class="detail-panel hidden">
        <div class="detail-header">
            <h3 id="detailTitle">Resource Details</h3>
            <button onclick="closeDetailPanel()" class="close-btn">&times;</button>
        </div>
        <div class="detail-actions">
            <button id="editBtn" onclick="toggleEditMode()">‚úèÔ∏è Edit</button>
            <button id="saveBtn" onclick="saveResource()" class="hidden">üíæ Save</button>
            <button id="cancelBtn" onclick="cancelEdit()" class="hidden">‚ùå Cancel</button>
            <button id="expandAllBtn" onclick="expandAll()">üìÇ Expand All</button>
            <button id="collapseAllBtn" onclick="collapseAll()">üìÅ Collapse All</button>
        </div>
        <div class="detail-body">
            <div id="jsonTreeView" class="json-tree"></div>
            <textarea id="resourceEditor" class="hidden"></textarea>
        </div>
    </div>

    <script>
        // Wait for all scripts to load before registering
        window.addEventListener('DOMContentLoaded', function () {
            if (typeof cytoscape !== 'undefined' && typeof cytoscapeDagre !== 'undefined') {
                cytoscape.use(cytoscapeDagre);
                console.log('Dagre extension registered successfully');
            } else {
                console.error('Failed to register dagre:', {
                    cytoscape: typeof cytoscape,
                    cytoscapeDagre: typeof cytoscapeDagre
                });
            }
        });

        // State
        const state = {
            cluster: 'default',
            namespace: 'default',
            resourceType: 'maturity',
            view: 'analysis'
        };

        // UI Elements
        const els = {
            clusterUpload: document.getElementById('clusterUpload'),
            clusterUploadToggle: document.getElementById('clusterUploadToggle'),
            kubeconfigFileNameLabel: document.getElementById('kubeconfigFileName'),
            clusterSelect: document.getElementById('clusterSelect'),
            kubeconfigFile: document.getElementById('kubeconfigFile'),
            kubeconfigName: document.getElementById('kubeconfigName'),
            kubeconfigContext: document.getElementById('kubeconfigContext'),
            kubeconfigInsecure: document.getElementById('kubeconfigInsecure'),
            uploadBtn: document.getElementById('uploadKubeconfigBtn'),
            uploadStatus: document.getElementById('uploadStatus'),
            nsSelect: document.getElementById('nsSelect'),
            resourceGrid: document.getElementById('resourceGrid'),
            eventGrid: document.getElementById('eventGrid'),
            refreshBtn: document.getElementById('refreshBtn'),
            crumbCluster: document.getElementById('crumbCluster'),
            crumbResource: document.getElementById('crumbResource'),
            navItems: document.querySelectorAll('.nav-item'),
            listView: document.getElementById('listView'),
            graphView: document.getElementById('graphView'),
            createView: document.getElementById('createView'),
            analysisView: document.getElementById('analysisView'),
            maturityNotes: document.getElementById('maturityNotes'),
            maturityStatus: document.getElementById('maturityStatus'),
            maturityResults: document.getElementById('maturityResults'),
            maturitySearch: document.getElementById('maturitySearch'),
            loadEvidenceBtn: document.getElementById('loadEvidenceBtn'),
            maturityEvidence: document.getElementById('maturityEvidence'),
            maturitySummary: document.getElementById('maturitySummary'),
            maturityOverallBadge: document.getElementById('maturityOverallBadge'),
            runMaturityBtn: document.getElementById('runMaturityBtn'),
            loadCriteriaBtn: document.getElementById('loadCriteriaBtn'),
            downloadPdfBtn: document.getElementById('downloadPdfBtn'),
            clearMaturityBtn: document.getElementById('clearMaturityBtn'),
            llmProvider: document.getElementById('llmProvider'),
            llmModel: document.getElementById('llmModel'),
            llmApiKey: document.getElementById('llmApiKey'),
            maturityWizard: document.getElementById('maturityWizard'),
            maturityWizardClose: document.getElementById('maturityWizardClose'),
            maturityWizardGenerate: document.getElementById('maturityWizardGenerate'),
            maturityWizardSkip: document.getElementById('maturityWizardSkip'),
            maturityWizardPrev: document.getElementById('maturityWizardPrev'),
            maturityWizardNext: document.getElementById('maturityWizardNext'),
            maturityWizardRun: document.getElementById('maturityWizardRun'),
            maturityWizardContent: document.getElementById('maturityWizardContent'),
            maturityWizardProgress: document.getElementById('maturityWizardProgress'),
            maturityWizardLLM: document.getElementById('maturityWizardLLM'),
            maturityWizardSubtitle: document.getElementById('maturityWizardSubtitle')
        };

        // Initial Cytoscape instance
        let cy = null;

        function truncateText(value, maxLen = 240) {
            const str = String(value || '');
            if (str.length <= maxLen) return str;
            return str.slice(0, maxLen) + '‚Ä¶';
        }

        async function requestJSON(url, options = {}) {
            const res = await fetch(url, options);
            const contentType = (res.headers.get('content-type') || '').toLowerCase();
            const text = await res.text();

            let data = null;
            const trimmed = (text || '').trim();
            const looksLikeJSON = trimmed.startsWith('{') || trimmed.startsWith('[');
            const shouldParseJSON = (trimmed && contentType.includes('application/json')) || looksLikeJSON;

            if (shouldParseJSON) {
                try {
                    data = trimmed ? JSON.parse(text) : null;
                } catch (err) {
                    throw new Error(`Invalid JSON response (HTTP ${res.status}): ${truncateText(text)}`);
                }
            }

            if (!res.ok) {
                const message = data && typeof data === 'object' && data !== null && 'message' in data
                    ? data.message
                    : (trimmed ? truncateText(text) : res.statusText);
                throw new Error(message || `Request failed (HTTP ${res.status})`);
            }

            if (data === null) {
                throw new Error(`Unexpected non-JSON response (HTTP ${res.status}): ${truncateText(text)}`);
            }

            return data;
        }

        // Init
        async function init() {
            await fetchClusters();
            await fetchNamespaces();
            setView('analysis');
            setActiveNav('maturity');
            updateBreadcrumbs();
            restoreLLMSettings();
            restoreMaturityAnswers();
            await loadMaturityCriteria();
            loadMaturityEvidence();

            // Auto refresh DISABLED for stability
            // setInterval(refreshAll, 5000);
        }

        function setView(mode) {
            state.view = mode;

            const hideAll = () => {
                els.listView.classList.add('hidden');
                els.graphView.classList.add('hidden');
                els.createView.classList.add('hidden');
                els.analysisView.classList.add('hidden');
            };

            if (mode === 'analysis') {
                hideAll();
                els.analysisView.classList.remove('hidden');
            } else if (mode === 'list') {
                hideAll();
                els.listView.classList.remove('hidden');
            } else if (mode === 'graph') {
                hideAll();
                els.graphView.classList.remove('hidden');
                fetchTopology();
            } else if (mode === 'create') {
                hideAll();
                els.createView.classList.remove('hidden');
            }
        }

        async function fetchClusters() {
            try {
                const clusters = await requestJSON('/api/clusters');
                els.clusterSelect.innerHTML = '';
                clusters.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    els.clusterSelect.appendChild(opt);
                });
                state.cluster = els.clusterSelect.value;
                updateBreadcrumbs();
            } catch (e) {
                console.error(e);
                els.uploadStatus.textContent = `Cluster list failed: ${e.message}`;
                els.uploadStatus.classList.add('error');
            }
        }

        async function fetchNamespaces() {
            try {
                const resp = await requestJSON(`/api/namespaces?cluster=${encodeURIComponent(state.cluster)}`);
                const namespaces = resp.namespaces || [];
                const allowAll = !!resp.allowAll;
                const defaultNamespace = resp.defaultNamespace || namespaces[0] || (allowAll ? 'all' : '');

                els.nsSelect.innerHTML = '';
                if (allowAll) {
                    const opt = document.createElement('option');
                    opt.value = 'all';
                    opt.textContent = 'All Namespaces';
                    els.nsSelect.appendChild(opt);
                }

                namespaces.forEach(ns => {
                    const opt = document.createElement('option');
                    opt.value = ns;
                    opt.textContent = ns;
                    els.nsSelect.appendChild(opt);
                });

                if (!allowAll && state.namespace === 'all') {
                    state.namespace = defaultNamespace;
                }
                if (!namespaces.includes(state.namespace)) {
                    state.namespace = defaultNamespace || namespaces[0] || (allowAll ? 'all' : '');
                }
                if (!state.namespace && allowAll) {
                    state.namespace = 'all';
                }

                if (state.namespace) {
                    els.nsSelect.value = state.namespace;
                }
            } catch (e) {
                console.error(e);
                els.nsSelect.innerHTML = `<option value="all">Error loading namespaces</option>`;
            }
        }

        async function fetchResources() {
            if (state.view !== 'list') return; // Don't fetch list in graph mode
            try {
                let url = `/api/resources?type=${encodeURIComponent(state.resourceType)}&cluster=${encodeURIComponent(state.cluster)}`;
                if (state.namespace && state.namespace !== 'all') url += `&namespace=${encodeURIComponent(state.namespace)}`;

                const items = await requestJSON(url);
                renderResources(items);
            } catch (e) {
                els.resourceGrid.innerHTML = `<div class="error-state">Failed: ${e.message}</div>`;
            }
        }

        async function fetchTopology() {
            if (state.view !== 'graph') return;
            try {
                let url = `/api/topology?cluster=${encodeURIComponent(state.cluster)}`;
                if (state.namespace) url += `&namespace=${encodeURIComponent(state.namespace)}`;
                const data = await requestJSON(url);
                renderTopology(data);
            } catch (e) {
                console.error("Topology fetch failed", e);
            }
        }

        async function fetchEvents() {
            if (state.view !== 'list') return;
            try {
                let url = `/api/events?cluster=${encodeURIComponent(state.cluster)}`;
                if (state.namespace && state.namespace !== 'all') url += `&namespace=${encodeURIComponent(state.namespace)}`;

                const items = await requestJSON(url);
                renderEvents(items);
            } catch (e) {
                console.error(e);
                els.eventGrid.innerHTML = `<tr><td colspan="5" class="empty-cell">${e.message}</td></tr>`;
            }
        }

        function formatTimestamp(ts) {
            const date = new Date(ts);
            if (Number.isNaN(date.getTime())) return ts;
            return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        }

        function renderTopology(data) {
            if (!data.nodes) return;

            // Deduplicate edges
            const edgeSet = new Set();
            const uniqueEdges = data.edges.filter(e => {
                const key = `${e.source}->${e.target}`;
                if (edgeSet.has(key)) {
                    return false;
                }
                edgeSet.add(key);
                return true;
            });

            const elements = [
                ...data.nodes.map(n => ({
                    data: {
                        id: n.id,
                        label: n.label,
                        type: n.type,
                        parent: n.parent,
                        status: n.status,
                        age: n.age,
                        details: n.details,
                        namespace: n.namespace
                    }
                })),
                ...uniqueEdges.map(e => ({ data: { source: e.source, target: e.target } }))
            ];

            if (cy) {
                cy.destroy();
            }

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    // ... (styles remain same)
                    {
                        selector: 'node',
                        style: {
                            'background-color': 'rgba(0,0,0,0)', // Transparent, handled by HTML
                            'border-width': 0,
                            'width': 180, // Match card width
                            'height': 100
                        }
                    },
                    {
                        selector: ':parent',
                        style: {
                            'text-valign': 'top',
                            'text-halign': 'center',
                            'background-color': 'rgba(30, 41, 59, 0.4)',
                            'border-color': '#475569',
                            'border-width': 2,
                            'border-style': 'dashed',
                            'shape': 'roundrectangle',
                            'label': function (ele) {
                                const type = ele.data('type');
                                const label = ele.data('label');
                                if (type === 'deployment') return 'üì¶ Deployment: ' + label;
                                if (type === 'statefulset') return 'üóÑÔ∏è StatefulSet: ' + label;
                                if (type === 'daemonset') return 'üîÑ DaemonSet: ' + label;
                                return label;
                            },
                            'color': '#cbd5e1',
                            'padding': 20
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#64748b',
                            'target-arrow-color': '#64748b',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'arrow-scale': 1.5
                        }
                    }
                ]
            });

            // Custom horizontal positioning
            const nodeWidth = 180;
            const nodeHeight = 100;
            const colGap = 60;
            const rowGap = 80;  // Reduced from 150
            const podWidth = 180;  // Width for pods

            // Group nodes by their "chain" (ingress->service->deployment->pods)
            const ingresses = cy.nodes('[type="ingress"]');
            const services = cy.nodes('[type="service"]');
            const deployments = cy.nodes('[type="deployment"], [type="statefulset"]');
            const configs = cy.nodes('[type="configmap"], [type="secret"], [type="pvc"]');
            const standalonePods = cy.nodes('[type="pod"]').filter(n => !n.data('parent'));

            let currentY = 50;

            // Position each deployment chain horizontally
            deployments.forEach((deploy, idx) => {
                const chainY = currentY + (idx * (nodeHeight * 2 + rowGap));  // Reduced multiplier

                // Find connected service
                const connectedSvc = services.filter(svc => {
                    return cy.edges().some(e => e.data('source') === svc.id() && e.data('target') === deploy.id());
                });

                // Find connected ingress
                const connectedIng = ingresses.filter(ing => {
                    return cy.edges().some(e => {
                        const svcId = e.data('target');
                        return e.data('source') === ing.id() && connectedSvc.some(s => s.id() === svcId);
                    });
                });

                // Position: Ingress (x=0), Service (x=1), Deployment (x=2)
                connectedIng.forEach(ing => ing.position({ x: 100, y: chainY + nodeHeight / 2 }));
                connectedSvc.forEach(svc => svc.position({ x: 100 + nodeWidth + colGap, y: chainY + nodeHeight / 2 }));
                deploy.position({ x: 100 + 2 * (nodeWidth + colGap), y: chainY + nodeHeight / 2 });

                // Position child pods inside deployment box - spread them out more
                const childPods = cy.nodes(`[parent="${deploy.id()}"]`);
                const deployX = 100 + 2 * (nodeWidth + colGap);
                childPods.forEach((pod, pIdx) => {
                    pod.position({
                        x: deployX + 60 + (pIdx * (podWidth + 20)),  // Increased spacing
                        y: chainY + nodeHeight / 2
                    });
                });

                // Position configs below deployment - with more spacing
                const connectedConfigs = configs.filter(cfg => {
                    return cy.edges().some(e => e.data('source') === deploy.id() && e.data('target') === cfg.id());
                });
                const configStartX = deployX - 50;
                connectedConfigs.forEach((cfg, cIdx) => {
                    cfg.position({
                        x: configStartX + (cIdx * (nodeWidth + 40)),  // More horizontal spacing
                        y: chainY + nodeHeight * 2.5  // Move further below
                    });
                });
            });

            // Position standalone services (like kubernetes)
            const standaloneServices = services.filter(svc => {
                return !cy.edges().some(e => e.data('source') === svc.id());
            });
            standaloneServices.forEach((svc, idx) => {
                svc.position({ x: 100 + (idx * (nodeWidth + colGap)), y: currentY + deployments.length * (nodeHeight * 3 + rowGap) });
            });

            // Position standalone pods
            standalonePods.forEach((pod, idx) => {
                pod.position({ x: 300 + (idx * (nodeWidth + colGap)), y: currentY + deployments.length * (nodeHeight * 3 + rowGap) });
            });

            cy.fit(50);
            console.log('Manual horizontal layout applied');

            // Enable HTML Labels
            cy.nodeHtmlLabel([
                {
                    query: 'node:childless', // Apply to all non-parent nodes
                    cssClass: 'node-card-wrapper',
                    tpl: function (data) {
                        let statusClass = 'status-other';
                        const s = (data.status || '').toLowerCase();
                        if (s.includes('run') || s.includes('active') || s.includes('bound') || s.includes('succeed')) statusClass = 'status-running';
                        if (s.includes('fail') || s.includes('error')) statusClass = 'status-error';

                        // Icon based on type
                        let icon = 'üì¶';
                        if (data.type === 'pod') icon = 'üßä';
                        if (data.type === 'service') icon = '‚ö°';
                        if (data.type === 'ingress') icon = 'üåê';
                        if (data.type === 'pvc') icon = 'üíæ';
                        if (data.type === 'configmap' || data.type === 'secret') icon = 'üìù';

                        // Card HTML similar to List View
                        return `
                            <div class="node-card">
                                <div class="node-header">
                                    <span class="node-type">${icon} ${data.type}</span>
                                    <span class="status-indicator ${statusClass}">${data.status || '?'}</span>
                                </div>
                                <div class="node-name" title="${data.label}">${data.label}</div>
                                <div class="node-meta">
                                    ${data.details ? `<div>${data.details}</div>` : ''}
                                    ${data.age ? `<div class="node-age">${data.age}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                }
            ]);

            // Double click - open detail panel (no zoom)
            cy.on('dbltap', 'node', function (evt) {
                var node = evt.target;
                var data = node.data();

                // Skip if no type (shouldn't happen)
                if (!data.type) return;

                var type = data.type;
                var name = data.label;
                var namespace = data.namespace || state.namespace;
                openResourceDetail(type, name, namespace);
            });
        }

        function renderResources(items) {
            els.resourceGrid.innerHTML = '';
            if (!items || items.length === 0) {
                els.resourceGrid.innerHTML = '<div class="empty-state">No resources found.</div>';
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'resource-card';
                card.style.cursor = 'pointer';

                // Click to open detail panel
                card.addEventListener('click', () => {
                    openResourceDetail(item.type.toLowerCase(), item.name, item.namespace);
                });

                // Simple status logic
                let statusClass = 'status-other';
                const s = item.status.toLowerCase();
                if (s.includes('run') || s.includes('active') || s.includes('succeed')) statusClass = 'status-running';
                if (s.includes('fail') || s.includes('error')) statusClass = 'status-error';

                card.innerHTML = `
                    <div class="card-header">
                        <span class="res-type">${item.type}</span>
                        <span class="status-indicator ${statusClass}">${item.status}</span>
                    </div>
                    <h3 class="res-name" title="${item.name}">${item.name}</h3>
                    <div class="res-meta">
                        <div class="meta-row"><span>NS:</span> ${item.namespace}</div>
                        <div class="meta-row"><span>Age:</span> ${item.age}</div>
                        ${item.details ? `<div class="meta-row details"><span>Info:</span> ${item.details}</div>` : ''}
                    </div>
                `;
                els.resourceGrid.appendChild(card);
            });
        }

        function renderEvents(items) {
            els.eventGrid.innerHTML = '';
            if (!items || items.length === 0) {
                els.eventGrid.innerHTML = '<tr><td colspan="5" class="empty-cell">No events found.</td></tr>';
                return;
            }
            items.forEach(ev => {
                const tr = document.createElement('tr');
                const typeClass = ev.type === 'Warning' ? 'type-warning' : 'type-normal';
                tr.innerHTML = `
                    <td><span class="event-badge ${typeClass}">${ev.type}</span></td>
                    <td>${ev.reason}</td>
                    <td class="object-cell">${ev.object}</td>
                    <td class="message-cell" title="${ev.message}">${ev.message}</td>
                    <td class="age-cell">${ev.age}</td>
                `;
                els.eventGrid.appendChild(tr);
            });
        }

        function refreshAll() {
            els.refreshBtn.classList.add('rotating');
            if (state.view === 'analysis') {
                Promise.resolve(loadMaturityEvidence())
                    .finally(() => setTimeout(() => els.refreshBtn.classList.remove('rotating'), 250));
                return;
            }
            const promises = [fetchResources(), fetchEvents()];
            if (state.view === 'graph') {
                promises.push(fetchTopology());
            }
            Promise.all(promises)
                .then(() => setTimeout(() => els.refreshBtn.classList.remove('rotating'), 500));
        }

        function refreshKubeconfigFileLabel() {
            if (!els.kubeconfigFile || !els.kubeconfigFileNameLabel) return;
            const file = els.kubeconfigFile.files[0];
            els.kubeconfigFileNameLabel.textContent = file ? file.name : 'Dosya se√ßilmedi';
        }

        function updateBreadcrumbs() {
            els.crumbCluster.textContent = state.cluster;
            const item = document.querySelector(`.nav-item[data-type="${state.resourceType}"]`);
            els.crumbResource.textContent = item ? item.textContent : state.resourceType;
        }

        // Listeners
        els.navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('.nav-item.active')?.classList.remove('active');
                item.classList.add('active');

                const type = item.dataset.type;
                if (type === 'maturity') {
                    state.resourceType = type;
                    setView('analysis');
                    updateBreadcrumbs();
                    loadMaturityCriteria();
                } else if (type === 'topology') {
                    setView('graph');
                    els.crumbResource.textContent = "Topology";
                } else if (type === 'create') {
                    setView('create');
                    els.crumbResource.textContent = "Create Resource";
                    initCreatePreview();
                } else {
                    state.resourceType = type;
                    setView('list');
                    updateBreadcrumbs();
                    refreshAll();
                }
            });
        });

        if (els.clusterUpload && els.clusterUploadToggle) {
            els.clusterUploadToggle.setAttribute('aria-expanded', String(els.clusterUpload.classList.contains('open')));
            els.clusterUploadToggle.addEventListener('click', () => {
                const isOpen = els.clusterUpload.classList.toggle('open');
                els.clusterUploadToggle.setAttribute('aria-expanded', String(isOpen));
            });
        }

        if (els.kubeconfigFile) {
            els.kubeconfigFile.addEventListener('change', refreshKubeconfigFileLabel);
        }
        refreshKubeconfigFileLabel();

        els.clusterSelect.addEventListener('change', (e) => {
            state.cluster = e.target.value;
            fetchNamespaces().then(() => {
                if (state.view === 'analysis') {
                    maturityLastReport = null;
                    maturityLastEvidence = null;
                    restoreMaturityAnswers();
                    if (els.maturityEvidence) {
                        els.maturityEvidence.classList.add('empty');
                        els.maturityEvidence.textContent = 'Hen√ºz y√ºklenmedi.';
                    }
                    loadMaturityCriteria().then(loadMaturityEvidence);
                }
                else refreshAll();
            });
            updateBreadcrumbs();
        });

        els.nsSelect.addEventListener('change', (e) => {
            state.namespace = e.target.value;
            refreshAll();
        });

        els.refreshBtn.addEventListener('click', refreshAll);

        function setActiveNav(type) {
            const item = document.querySelector(`.nav-item[data-type="${type}"]`);
            if (!item) return;
            document.querySelector('.nav-item.active')?.classList.remove('active');
            item.classList.add('active');
        }

        let maturityCriteriaDoc = null;
        let maturityLastReport = null;
        let maturityLastEvidence = null;
        let maturityAnswers = {};
        let maturityWizardQuestions = [];
        let maturityWizardIndex = 0;
        let maturityWizardSelections = {};

        async function loadMaturityCriteria() {
            if (!els.maturityStatus || !els.maturityResults) return;
            els.maturityStatus.textContent = 'Loading criteria...';
            els.maturityStatus.classList.remove('error', 'success');
            try {
                maturityCriteriaDoc = await requestJSON('/api/maturity/criteria');
                els.maturityStatus.textContent = `Loaded ${maturityCriteriaDoc.categories?.length || 0} categories.`;
                els.maturityStatus.classList.add('success');
                renderMaturityUI(maturityCriteriaDoc, maturityLastReport);
            } catch (e) {
                els.maturityStatus.textContent = `Criteria load failed: ${e.message}`;
                els.maturityStatus.classList.add('error');
            }
        }

        function renderMaturityUI(doc, report) {
            if (!doc) return;
            const categories = doc.categories || [];
            const query = (els.maturitySearch?.value || '').trim().toLowerCase();
            const scoreByKey = new Map();
            if (report && report.criteriaScores) {
                report.criteriaScores.forEach(s => scoreByKey.set(s.key, s));
            }
            const inferredByKey = new Map();
            if (maturityLastEvidence && Array.isArray(maturityLastEvidence.inferredScores)) {
                maturityLastEvidence.inferredScores.forEach(s => inferredByKey.set(s.key, s));
            }

            renderMaturitySummary(report);
            const precheckSummary = (!report && maturityCriteriaDoc && maturityLastEvidence && Array.isArray(maturityLastEvidence.inferredScores))
                ? computeSummaryFromScores(maturityCriteriaDoc, maturityLastEvidence.inferredScores)
                : null;
            const scoreSource = report || precheckSummary;

            const html = categories.map(cat => {
                const crit = cat.criteria || [];
                const filtered = query
                    ? crit.filter(c => (c.name || '').toLowerCase().includes(query))
                    : crit;
                if (filtered.length === 0) return '';

                const catScore = getCategoryScore(scoreSource, cat.title);
                const catBadge = catScore ? `<span class="maturity-chip level-${Math.round(catScore)}">L${catScore.toFixed(1)}</span>` : `<span class="maturity-chip level-0">‚Äî</span>`;

                const rows = filtered.map(cr => {
                    const s = scoreByKey.get(cr.key);
                    const inf = inferredByKey.get(cr.key);
                    const base = s && (s.level || 0) > 0 ? s : (inf && (inf.level || 0) > 0 ? inf : null);
                    const levelNum = base ? (base.level || 0) : 0;
                    const confidence = base && typeof base.confidence === 'number' ? base.confidence : 0;
                    const confPct = Math.round(confidence * 100);
                    const rationale = base && base.rationale ? escapeHTML(base.rationale) : '';
                    const evidence = base && base.evidence && base.evidence.length ? escapeHTML(base.evidence.slice(0, 3).join(' ‚Ä¢ ')) : '';
                    let missing = (s && Array.isArray(s.missing) && s.missing.length) ? s.missing : [];
                    if (!missing.length) {
                        missing = defaultQuestionsForCriterion(cr);
                    }
                    const answer = (maturityAnswers && cr.key in maturityAnswers) ? (maturityAnswers[cr.key] || '') : '';
                    const hasAnswer = !!String(answer).trim();
                    const detailsId = `maturity-details-${cr.key}`;
                    return `
                        <div class="maturity-row">
                            <div class="maturity-row-main">
                                <div class="maturity-row-title">${escapeHTML(cr.name)}</div>
                                ${rationale ? `<div class="maturity-row-sub">${rationale}</div>` : `<div class="maturity-row-sub muted">Skor yok. Analyze √ßalƒ±≈ütƒ±rabilir veya bilgi ekleyebilirsiniz.</div>`}
                                ${evidence ? `<div class="maturity-row-evidence">${evidence}</div>` : ``}
                                <div class="maturity-row-actions">
                                    <button class="maturity-link" type="button" data-toggle="${escapeHTML(detailsId)}">${hasAnswer ? 'Cevabƒ± d√ºzenle' : 'Bilgi ekle'}</button>
                                </div>
                                <div class="maturity-details hidden" id="${escapeHTML(detailsId)}">
                                    ${missing.length ? `
                                        <div class="maturity-details-block">
                                            <div class="maturity-details-title">Sorular</div>
                                            <ul class="maturity-details-list">
                                                ${missing.slice(0, 6).map(q => `<li>${escapeHTML(q)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ``}
                                    <div class="maturity-details-block">
                                        <div class="maturity-details-title">Cevabƒ±n (opsiyonel)</div>
                                        <textarea class="maturity-answer" data-answer-key="${escapeHTML(cr.key)}" placeholder="Bu kriterin mevcut durumunu ve kanƒ±tlarƒ± yaz (link/komut √ßƒ±ktƒ±sƒ±/ekip s√ºreci...)">${escapeHTML(answer)}</textarea>
                                        <div class="maturity-details-actions">
                                            <button class="maturity-btn" type="button" data-save-answer="${escapeHTML(cr.key)}">Kaydet</button>
                                            <button class="maturity-btn" type="button" data-clear-answer="${escapeHTML(cr.key)}">Temizle</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="maturity-row-metrics">
                                <div class="maturity-chip level-${levelNum}">${levelNum ? `L${levelNum}` : '‚Äî'}</div>
                                <div class="maturity-conf" title="Confidence">
                                    <div class="maturity-conf-bar"><span style="width:${confPct}%"></span></div>
                                    <div class="maturity-conf-text">${levelNum ? `${confPct}%` : '‚Äî'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <section class="maturity-section">
                        <div class="maturity-section-header">
                            <div class="maturity-section-title">${escapeHTML(cat.title || cat.id || 'Category')}</div>
                            <div class="maturity-section-meta">
                                <span class="maturity-muted">${filtered.length} kriter</span>
                                ${catBadge}
                            </div>
                        </div>
                        <div class="maturity-section-body">
                            ${rows}
                        </div>
                    </section>
                `;
            }).join('');

            els.maturityResults.innerHTML = html || `<div class="maturity-empty">E≈üle≈üen kriter bulunamadƒ±.</div>`;
            attachMaturityDetailHandlers();
        }

        function escapeHTML(str) {
            return String(str || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function defaultQuestionsForCriterion(cr) {
            const out = [
                'Bu kriter i√ßin mevcut durum hangi seviye? (L1‚ÄìL5 se√ßin veya kƒ±saca a√ßƒ±klayƒ±n)',
                'Kanƒ±t var mƒ±? (√∂r. YAML/komut √ßƒ±ktƒ±sƒ±/runbook/ADR linki)'
            ];
            const levels = Array.isArray(cr.levels) ? cr.levels : [];
            if (levels.length === 5) {
                const parts = levels.map((v, i) => {
                    const text = String(v || '').replaceAll('\\n', ' ').trim();
                    if (!text) return null;
                    return `L${i + 1}=${truncateText(text, 70)}`;
                }).filter(Boolean);
                if (parts.length) out.push('Seviye se√ßenekleri (√∂zet): ' + parts.join(' | '));
            }
            const name = String(cr.name || '').toLowerCase();
            const label = String(cr.name || '').trim() || 'Bu kriter';
            if (label) {
                out.push(`${label} kriteri i√ßin hangi komutlar/raporlar/kanƒ±tlar mevcut?`);
            }
            const cmdSuggestions = suggestCommandsForCriterion(name);
            if (cmdSuggestions.length) {
                out.push(`Bu kriteri doƒürulamak i√ßin ≈üu komutlardan birinin √ßƒ±ktƒ±sƒ±nƒ± ekleyin: ${cmdSuggestions.map(c => `\`${c}\``).join(' / ')}`);
            }
            // Security odaklƒ± ek sorular
            if (name === 'service account policy') {
                out.push('Uygulamalar default ServiceAccount mƒ± kullanƒ±yor, yoksa her uygulama i√ßin ayrƒ± SA var mƒ±?');
                out.push('Default SA i√ßin `automountServiceAccountToken` kapalƒ± mƒ±? Hangi namespace‚Äôlerde?');
            } else if (name === 'user access model') {
                out.push('Cluster-admin rol√º kimlerde var? (takƒ±m/ki≈üi listesi)');
                out.push('Prod/stage/dev i√ßin ayrƒ± RBAC mi var, yoksa ortak mƒ±?');
            } else if (name === 'privileged access') {
                out.push('K√∂k/privileged eri≈üimler nasƒ±l veriliyor? Sadece break-glass mƒ±, yoksa g√ºnl√ºk i≈ülerde de mi kullanƒ±lƒ±yor?');
                out.push('sudo/privileged pod √ßalƒ±≈ütƒ±rmak i√ßin onay s√ºreci var mƒ±?');
            } else if (name === 'approval process') {
                out.push('Prod‚Äôa deploy/konfig deƒüi≈üikliƒüi i√ßin kim onay veriyor? S√ºre√ß tool bazlƒ± mƒ± (√∂r. Git PR) yoksa manuel mi?');
            } else if (name === 'audit & review') {
                out.push('RBAC/policy review‚Äôleri hangi sƒ±klƒ±kta yapƒ±lƒ±yor (yapƒ±lƒ±yorsa)?');
                out.push('Audit loglarƒ± nerede tutuluyor, kimler eri≈üebiliyor?');
            } else if (name === 'initial audit') {
                out.push('Son CIS/kube-bench/skaner √ßƒ±ktƒ±sƒ± var mƒ±? √ñzetini buraya koyabilir veya link verebilirsiniz.');
            } else if (name === 'api server config') {
                out.push('API server i√ßin audit-policy, anonymous access, insecure port gibi ayarlarƒ±nƒ±zƒ±n √∂zetini yazƒ±n.');
                out.push('Apiserver config‚Äôi Git ile mi y√∂netiliyor yoksa manuel m√º?');
            } else if (name === 'etcd encryption') {
                out.push('etcd i√ßin at-rest encryption aktif mi? (apiserver flag veya dok√ºmantasyon linki).');
            } else if (name === 'kubelet hardening') {
                out.push('Kubelet i√ßin read-only port kapalƒ± mƒ±, kubelet authz/authn ayarlarƒ± nasƒ±l?');
            } else if (name === 'pod security') {
                out.push('Prod namespace‚Äôlerde hangi Pod Security level enforce ediliyor (baseline/restricted)?');
                out.push('PSA/PSP/OPA/ Kyverno ile zorunlu kƒ±ldƒ±ƒüƒ±nƒ±z √∂nemli kurallar neler?');
            } else if (name === 'remediation') {
                out.push('Policy ihlali veya vulnerability bulununca otomatik d√ºzeltme var mƒ±, yoksa manuel mi? √ñrnek s√ºre√ß yazƒ±n.');
            } else if (name === 'image scanning') {
                out.push('ƒ∞majlar hangi a≈üamada taranƒ±yor (CI, registry, runtime)? Hangi tool kullanƒ±lƒ±yor (Trivy, Grype, Aqua vb.)?');
            } else if (name === 'secrets mgmt') {
                out.push('Kritik secret‚Äôlar Kubernetes Secret mƒ±, yoksa external (Vault, SOPS, SealedSecrets, KMS) mƒ±?');
            } else if (name === 'image pull policy') {
                out.push('Prod ortamda `imagePullPolicy` i√ßin genel yakla≈üƒ±mƒ±nƒ±z nedir (Always/IfNotPresent)? Tag stratejinizi √∂zetleyin.');
            }
            if (name === 'rto/rpo tanimi' || name === 'rto/rpo tanƒ±mƒ±') {
                out.push('RTO ve RPO hedefleri nerede dok√ºmante ediliyor? Hangi ortamlar i√ßin ka√ß dakika/saat hedefi var?');
                out.push('Backup aracƒ± (Velero veya benzeri) bu hedefleri nasƒ±l kar≈üƒ±lƒ±yor? Schedule √ßƒ±ktƒ±sƒ± veya policy linki ekleyin.');
            } else if (name === 'data retention') {
                out.push('Log/data retention policy\'niz nedir? Saklama s√ºresi, tier ve storage sƒ±nƒ±flarƒ± nelerdir?');
                out.push('Retention ayarlarƒ± Git ile mi y√∂netiliyor, yoksa manuel mi? Hangi storage sƒ±nƒ±flarƒ±ndan faydalanƒ±yorsunuz?');
            } else if (name === 'log retention') {
                out.push('Log retention politikasƒ± ne kadar s√ºr√ºyor? (√∂rneƒüin 30 g√ºn, 90 g√ºn vs.)');
                out.push('Retention kontrol√º nerede tutuluyor (Loki, Elasticsearch, Cloud)? √ñrnek komut veya dashboard linki payla≈üƒ±n.');
            } else if (name === 'audit log') {
                out.push('Audit loglar nereye g√∂nderiliyor? (Loki, Elasticsearch, Cloud Audit Logging vb.)');
                out.push('Kimler audit loglara eri≈üebiliyor ve retention/silme politikasƒ± nedir?');
            }
            if (name === 'backup location') {
                out.push('Velero BackupStorageLocation (veya ba≈üka storage tanƒ±mƒ±) nerede? Hangi hedef (s3, gcs, azure) kullanƒ±lƒ±yor?');
                out.push('Location i√ßin bucket/container, region, encryption bilgisi var mƒ±?');
            } else if (name === 'backup frequency') {
                out.push('Backup schedule‚Äôlar nasƒ±l organizedir? (g√ºnl√ºk, saatlik, namespace bazlƒ± vs.)');
            } else if (name === 'backup encryption') {
                out.push('Storage location i√ßin encryption/KMS ayarlarƒ±nƒ± payla≈üƒ±n (kmsKeyId, encryption key).');
                out.push('Backup i√ßeriƒüi at-rest ≈üifreli mi? Hangi ara√ßla?');
            } else if (name === 'backup scope') {
                out.push('Hangi namespace/cluster component‚Äôlar backup alƒ±nƒ±yor? Velero schedule/backup legend‚Äôi var mƒ±?');
            } else if (name === 'restore testing') {
                out.push('Restore testi yaptƒ±nƒ±z mƒ±? Hangi backup/namespace ile, hangi zaman diliminde?');
            } else if (name === 'restore proc') {
                out.push('Restore prosed√ºr√º adƒ±m adƒ±m nedir? (Velero restore, manuel restore vs.)');
            }
            if (name === 'utilization analysis') {
                out.push('Utilization analizi i√ßin hangi metric stack mevcut (Prometheus, kube-state-metrics vb.)?');
                out.push('Hangi ekipler veya dashboard‚Äôlar bu metrikleri izliyor?');
            } else if (name === 'over-provisioning') {
                out.push('ResourceQuota/LimitRange politikalarƒ± var mƒ±? Hangi namespace‚Äôler i√ßin uygulanƒ±yor?');
                out.push('Kaynaklarƒ± kƒ±sƒ±tlamak i√ßin hangi s√ºre√ßler kullanƒ±lƒ±yor? (√∂r. GitOps, policy)');
            } else if (name === 'auto rightsizing') {
                out.push('HPA/Cluster autoscaler mutlaka var mƒ±? Hangi deployment/HPA bu s√ºrece dahil?');
                out.push('Rightsizing kararlarƒ± nerede dok√ºmante ediliyor veya otomasyonla uygulanƒ±yor?');
            } else if (name === 'cost reporting') {
                out.push('Maliyet raporlamasƒ±nƒ± hangi ara√ßlar hazƒ±rlƒ±yor? (Grafana dashboard, Cloud billing, vb.)');
                out.push('Per-application/per-cluster raporlar nerede saklanƒ±yor?');
            } else if (name === 'instance strategy') {
                out.push('Node pool stratejiniz ne? (pool isimleri, √ßalƒ±≈üma saatleri, √∂zel etiketler)');
                out.push('√ñzel donanƒ±m/spot/preemptible node kullanƒ±mƒ± nasƒ±l planlanƒ±yor?');
            } else if (name === 'spot usage') {
                out.push('Spot/preemptible node‚Äôlar cluster‚Äôda var mƒ±? Hangi label/taint ile tanƒ±mlanƒ±yorlar?');
                out.push('Spot node kullanƒ±mƒ±nƒ± hangi servisler t√ºketiyor?');
            } else if (name === 'node pool strategy') {
                out.push('Node pool isimleri ve ama√ßlarƒ±nƒ± a√ßƒ±klayƒ±n (prod, staging, GPU, vb.).');
                out.push('Node pool ≈üemasƒ±/etiketleri nerede saklanƒ±yor?');
            } else if (name === 'cost savings') {
                out.push('Maliyet optimizasyonu i√ßin hangi inisiyatifler var? (e.g. spot, rightsizing, autoscaling)');
            } else if (name === 'cost allocation') {
                out.push('Maliyetleri namespace/label bazƒ±nda nasƒ±l ayƒ±rƒ±yorsunuz?');
            } else if (name === 'budget control') {
                out.push('B√ºt√ße uyarƒ±larƒ± nerede tanƒ±mlƒ±? (Grafana alert, Cloud budgets, pagerduty vb.)');
            } else if (name === 'finops culture') {
                out.push('FinOps ekip/ba≈ülƒ±klarƒ± nasƒ±l organize? (per-app, center of excellence)?');
            } else if (name === 'savings tracking') {
                out.push('Tasarruf hedeflerini kim takip ediyor? (dashboard, runbook, vs.)');
            }
            if (name === 'deployment') {
                out.push('Deployment s√ºreciniz otomatik mi? Hangi tool(lar) ile tetikleniyor?');
            } else if (name === 'git structure') {
                out.push('Deployment repo yapƒ±nƒ±z nasƒ±l organize (monorepo, team dirs, vs.)?');
            } else if (name === 'rollback') {
                out.push('Rollback prosed√ºr√º ne? Hangi ara√ßlar veya playbooklar kullanƒ±lƒ±yor?');
            } else if (name === 'audit trail') {
                out.push('Audit verisi nerede saklanƒ±yor? (events, Cloud Audit Logging, vs.)');
                out.push('Kimler audit trail raporlarƒ±nƒ± t√ºketiyor?');
            } else if (name === 'helm usage') {
                out.push('Helm release/values y√∂netimi nasƒ±l yapƒ±lƒ±r? (helmfile, helm3, custom scripts)');
            } else if (name === 'values mgmt') {
                out.push('Values/secret y√∂netimi nasƒ±l? (SealedSecrets, external secrets, etc.)');
            } else if (name === 'chart testing') {
                out.push('Chart‚Äôlarƒ±nƒ±z CI/CD‚Äôde nasƒ±l test ediliyor (helm lint, chart-testing, vs.)?');
            } else if (name === 'release mgmt') {
                out.push('Release planlama/approval s√ºre√ßleri nasƒ±l i≈üliyor? (ArgoCD/Fleet, approvals)');
            } else if (name === 'kubectl commands') {
                out.push('Hangi kubectl komutlarƒ±nƒ± otomatik veya manuel √ßalƒ±≈ütƒ±rƒ±yorsunuz?');
                out.push('Pod/cluster d√ºzeyinde sƒ±k kullanƒ±lan komutlar nelerdir?');
            } else if (name === 'pod debugging') {
                out.push('Pod debugging s√ºreci nasƒ±l? (kubectl exec, port-forward, ephemeral debug pod)');
            } else if (name === 'event analysis') {
                out.push('Event monit√∂r√ºn√ºz veya aggregate aracƒ± var mƒ±? (kubectl get events, ELK, Loki)');
            } else if (name === 'alert system') {
                out.push('Alert rule‚Äôlar nerede tanƒ±mlƒ±? Hangi platformu kullanƒ±yorsunuz (PrometheusRule, Cloud Alert)?');
            } else if (name === 'alert fatigue') {
                out.push('Alert sayƒ±sƒ± nasƒ±l y√∂netiliyor? (silencing, rate limiting, dedup)');
            } else if (name === 'on-call runbook') {
                out.push('On-call runbook dok√ºmantasyonunuz nerede? (wiki, runbook repo, playbook)');
            } else if (name === 'mttr') {
                out.push('MTTR hedefi nedir? Hangi ara√ßlarla √∂l√ß√ºyorsunuz?');
            }
            return out;
        }

        function suggestCommandsForCriterion(lowerName) {
            const name = String(lowerName || '').toLowerCase();
            const cmds = [];
            const add = (...items) => items.forEach(i => { if (i && !cmds.includes(i)) cmds.push(i); });
            if (name.includes('networkpolicy') || name.includes('egress') || name.includes('cilium')) {
                add('kubectl get networkpolicy -A', 'kubectl get ciliumnetworkpolicies -A', 'kubectl get ciliumclusterwidenetworkpolicies');
            } else if (name.includes('ingress')) {
                add('kubectl get ingress -A', 'kubectl get ingressclass', 'kubectl get svc -A');
            } else if (name.includes('cert') || name.includes('tls')) {
                add('kubectl get certificates -A', 'kubectl get issuers -A', 'kubectl get clusterissuers');
            } else if (name.includes('prometheus') || name.includes('metrics') || name.includes('scrape')) {
                add('kubectl get prometheusrules -A', 'kubectl get servicemonitors -A', 'kubectl get podmonitors -A');
            } else if (name.includes('grafana') || name.includes('dashboards')) {
                add('kubectl get deploy -A | grep -i grafana', 'kubectl get svc -A | grep -i grafana');
            } else if (name.includes('log') || name.includes('loki')) {
                add('kubectl get deploy -A | grep -i loki', 'kubectl get pods -A | grep -i loki');
            } else if (name.includes('backup') || name.includes('restore') || name.includes('dr') || name.includes('velero')) {
                add('kubectl get schedules.velero.io -n velero', 'kubectl get backupstoragelocations.velero.io -n velero -o yaml', 'kubectl get backups.velero.io -A', 'kubectl get restores.velero.io -A');
            } else if (name.includes('longhorn')) {
                add('kubectl get backups.longhorn.io -A', 'kubectl get restores.longhorn.io -A', 'kubectl get pods -n longhorn-system');
            } else if (name.includes('hpa')) {
                add('kubectl get hpa -A', 'kubectl get deploy -A');
            } else if (name.includes('resourcequota')) {
                add('kubectl get resourcequota -A -o yaml');
            } else if (name.includes('limitrange')) {
                add('kubectl get limitrange -A -o yaml');
            } else if (name.includes('service account') || name.includes('rbac') || name.includes('cluster-admin')) {
                add('kubectl get sa -A', 'kubectl get clusterrolebinding', 'kubectl get rolebinding -A');
            } else {
                add('kubectl get all -A', 'kubectl get ns -o yaml');
            }
            return cmds.slice(0, 3);
        }

        async function runMaturityAnalysis() {
            if (!els.maturityStatus) return;
            // Guided wizard first (can be skipped inside the wizard).
            openMaturityWizard();
        }

        if (els.runMaturityBtn) {
            els.runMaturityBtn.addEventListener('click', runMaturityAnalysis);
        }
        if (els.loadCriteriaBtn) {
            els.loadCriteriaBtn.addEventListener('click', () => {
                maturityLastReport = null;
                loadMaturityCriteria();
            });
        }

        if (els.maturitySearch) {
            els.maturitySearch.addEventListener('input', () => renderMaturityUI(maturityCriteriaDoc, maturityLastReport));
        }

        if (els.loadEvidenceBtn) {
            els.loadEvidenceBtn.addEventListener('click', loadMaturityEvidence);
        }

        async function loadMaturityEvidence() {
            if (!els.maturityEvidence) return;
            els.maturityEvidence.classList.remove('empty');
            els.maturityEvidence.textContent = 'Loading...';
            try {
                maturityLastEvidence = await requestJSON(`/api/maturity/evidence?cluster=${encodeURIComponent(state.cluster)}`);
                renderMaturityEvidence(maturityLastEvidence);
            } catch (e) {
                els.maturityEvidence.classList.add('empty');
                els.maturityEvidence.textContent = `Evidence failed: ${e.message}`;
            }
        }

        function renderMaturityEvidence(ev) {
            if (!els.maturityEvidence) return;
            if (!ev) {
                els.maturityEvidence.classList.add('empty');
                els.maturityEvidence.textContent = 'Hen√ºz y√ºklenmedi.';
                return;
            }
            const addons = Object.keys(ev.detectedAddons || {}).filter(k => ev.detectedAddons[k]);
            const zones = (ev.zones || []).join(', ');
            const kubectlEntries = ev.kubectl ? Object.entries(ev.kubectl) : [];
            const kubectlErrors = kubectlEntries.filter(([k, v]) => String(v || '').includes('ERROR:'));
            els.maturityEvidence.innerHTML = `
                <div class="maturity-evidence-grid">
                    <div class="maturity-kv"><span>K8s</span><strong>${escapeHTML(ev.kubernetesVersion || '‚Äî')}</strong></div>
                    <div class="maturity-kv"><span>Nodes</span><strong>${ev.nodeCount ?? '‚Äî'}</strong></div>
                    <div class="maturity-kv"><span>Zones</span><strong>${escapeHTML(zones || '‚Äî')}</strong></div>
                    <div class="maturity-kv"><span>Namespaces</span><strong>${ev.namespaceCount ?? '‚Äî'}</strong></div>
                    <div class="maturity-kv"><span>Ingress</span><strong>${ev.ingressCount ?? '‚Äî'}</strong></div>
                    <div class="maturity-kv"><span>NetworkPolicy</span><strong>${ev.networkPolicyCount ?? '‚Äî'}</strong></div>
                </div>
                ${addons.length ? `<div class="maturity-chips">${addons.slice(0, 10).map(a => `<span class="maturity-chip subtle">${escapeHTML(a)}</span>`).join('')}</div>` : ``}
                ${kubectlErrors.length ? `
                    <details class="maturity-kubectl-errors">
                        <summary>Kubectl errors (${kubectlErrors.length})</summary>
                        <div class="maturity-kubectl-body">
                            ${kubectlErrors.slice(0, 6).map(([k, v]) => `<div class="maturity-kubectl-item"><div class="maturity-kubectl-cmd">${escapeHTML(k)}</div><pre>${escapeHTML(truncateText(v, 900))}</pre></div>`).join('')}
                        </div>
                    </details>
                ` : ``}
            `;
        }

        function getCategoryScore(report, categoryTitle) {
            if (!report || !Array.isArray(report.categoryScores)) return null;
            const found = report.categoryScores.find(c => c.category === categoryTitle);
            return found && typeof found.level === 'number' ? found.level : null;
        }

        function renderMaturitySummary(report) {
            if (!els.maturitySummary || !els.maturityOverallBadge) return;
            if (!report) {
                // Show a precheck summary if we have inferredScores from evidence.
                const inferred = maturityLastEvidence && Array.isArray(maturityLastEvidence.inferredScores)
                    ? maturityLastEvidence.inferredScores
                    : [];
                if (!inferred.length || !maturityCriteriaDoc) {
                    els.maturityOverallBadge.textContent = '‚Äî';
                    els.maturitySummary.innerHTML = `<div class="maturity-muted">Analyze √ßalƒ±≈ütƒ±rƒ±n veya bilgi ekleyin.</div>`;
                    return;
                }
                const summary = computeSummaryFromScores(maturityCriteriaDoc, inferred);
                els.maturityOverallBadge.textContent = summary ? `L${summary.overallLevel.toFixed(1)}` : '‚Äî';
                els.maturityOverallBadge.className = `maturity-badge ${summary ? `level-${Math.round(summary.overallLevel)}` : 'level-0'}`;
                const cats = summary ? summary.categoryScores : [];
                const catRows = cats.slice(0, 10).map(c => {
                    const lvl = typeof c.level === 'number' ? c.level : 0;
                    const pct = Math.max(0, Math.min(100, Math.round((lvl / 5) * 100)));
                    return `
                        <div class="maturity-score-row">
                            <div class="maturity-score-title">${escapeHTML(c.category)}</div>
                            <div class="maturity-score-bar"><span style="width:${pct}%"></span></div>
                            <div class="maturity-score-val">L${lvl.toFixed(1)}</div>
                        </div>
                    `;
                }).join('');
                els.maturitySummary.innerHTML = catRows || `<div class="maturity-muted">Precheck skoru yok.</div>`;
                return;
            }
            const overall = typeof report.overallLevel === 'number' ? report.overallLevel : null;
            els.maturityOverallBadge.textContent = overall ? `L${overall.toFixed(1)}` : '‚Äî';
            els.maturityOverallBadge.className = `maturity-badge ${overall ? `level-${Math.round(overall)}` : 'level-0'}`;

            const cats = Array.isArray(report.categoryScores) ? report.categoryScores : [];
            const catRows = cats.slice(0, 10).map(c => {
                const lvl = typeof c.level === 'number' ? c.level : 0;
                const pct = Math.max(0, Math.min(100, Math.round((lvl / 5) * 100)));
                return `
                    <div class="maturity-score-row">
                        <div class="maturity-score-title">${escapeHTML(c.category)}</div>
                        <div class="maturity-score-bar"><span style="width:${pct}%"></span></div>
                        <div class="maturity-score-val">L${lvl.toFixed(1)}</div>
                    </div>
                `;
            }).join('');
            els.maturitySummary.innerHTML = catRows || `<div class="maturity-muted">Kategori skoru yok.</div>`;
        }

        function computeSummaryFromScores(doc, scores) {
            const byCat = new Map();
            const scoreByKey = new Map();
            (scores || []).forEach(s => scoreByKey.set(s.key, s));
            (doc.categories || []).forEach(cat => {
                const levels = [];
                (cat.criteria || []).forEach(cr => {
                    const s = scoreByKey.get(cr.key);
                    const lvl = s && typeof s.level === 'number' ? s.level : 0;
                    if (lvl > 0) levels.push(lvl);
                });
                if (!levels.length) return;
                const avg = levels.reduce((a, b) => a + b, 0) / levels.length;
                byCat.set(cat.title, Math.round(avg * 10) / 10);
            });
            const cats = Array.from(byCat.keys()).sort();
            if (!cats.length) return null;
            const categoryScores = cats.map(c => ({ category: c, level: byCat.get(c) }));
            const overall = Math.round((categoryScores.reduce((a, b) => a + b.level, 0) / categoryScores.length) * 10) / 10;
            return { overallLevel: overall, categoryScores };
        }

        function persistMaturityAnswers() {
            try {
                localStorage.setItem(`kubeapp.maturity.answers.${state.cluster}`, JSON.stringify(maturityAnswers || {}));
            } catch (_) { }
        }

        function restoreMaturityAnswers() {
            try {
                const raw = localStorage.getItem(`kubeapp.maturity.answers.${state.cluster}`);
                maturityAnswers = raw ? JSON.parse(raw) : {};
            } catch (_) {
                maturityAnswers = {};
            }
        }


        function attachMaturityDetailHandlers() {
            document.querySelectorAll('.maturity-link[data-toggle]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-toggle');
                    const el = id ? document.getElementById(id) : null;
                    if (!el) return;
                    el.classList.toggle('hidden');
                });
            });

            document.querySelectorAll('[data-save-answer]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const key = btn.getAttribute('data-save-answer');
                    if (!key) return;
                    const ta = document.querySelector(`.maturity-answer[data-answer-key="${CSS.escape(key)}"]`);
                    const v = ta ? String(ta.value || '').trim() : '';
                    if (!maturityAnswers) maturityAnswers = {};
                    if (!v) delete maturityAnswers[key];
                    else maturityAnswers[key] = v;
                    persistMaturityAnswers();
                    renderMaturityUI(maturityCriteriaDoc, maturityLastReport);
                });
            });

            document.querySelectorAll('[data-clear-answer]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const key = btn.getAttribute('data-clear-answer');
                    if (!key) return;
                    if (maturityAnswers && key in maturityAnswers) delete maturityAnswers[key];
                    persistMaturityAnswers();
                    renderMaturityUI(maturityCriteriaDoc, maturityLastReport);
                });
            });
        }

        function buildLLMConfig() {
            const provider = (els.llmProvider?.value || 'auto').trim();
            const model = (els.llmModel?.value || '').trim();
            const apiKey = (els.llmApiKey?.value || '').trim();
            return { provider, model, apiKey };
        }

        async function downloadMaturityPDF() {
            if (!els.maturityStatus) return;
            els.maturityStatus.textContent = 'PDF hazƒ±rlanƒ±yor...';
            els.maturityStatus.classList.remove('error', 'success');
            try {
                persistLLMSettings();
                const body = {
                    userNotes: (els.maturityNotes?.value || '').trim(),
                    answers: maturityAnswers || {},
                    llm: buildLLMConfig()
                };
                const res = await fetch(`/api/maturity/report/pdf?cluster=${encodeURIComponent(state.cluster)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `HTTP ${res.status}`);
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `maturity-report-${state.cluster}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 5000);
                els.maturityStatus.textContent = 'PDF indirildi.';
                els.maturityStatus.classList.add('success');
            } catch (e) {
                els.maturityStatus.textContent = `PDF failed: ${e.message}`;
                els.maturityStatus.classList.add('error');
            }
        }

        if (els.downloadPdfBtn) els.downloadPdfBtn.addEventListener('click', downloadMaturityPDF);

        function clearMaturityData() {
            const ok = confirm('Notlar ve t√ºm manuel cevaplar temizlensin mi?');
            if (!ok) return;
            try {
                maturityAnswers = {};
                persistMaturityAnswers();
            } catch (_) { }
            try {
                if (els.maturityNotes) els.maturityNotes.value = '';
            } catch (_) { }
            try {
                maturityWizardQuestions = [];
                maturityWizardIndex = 0;
                maturityWizardSelections = {};
                closeMaturityWizard();
            } catch (_) { }
            try {
                maturityLastReport = null;
                if (els.maturityStatus) {
                    els.maturityStatus.textContent = 'Temizlendi.';
                    els.maturityStatus.classList.remove('error');
                    els.maturityStatus.classList.add('success');
                }
            } catch (_) { }
            renderMaturityUI(maturityCriteriaDoc, maturityLastReport);
        }

        if (els.clearMaturityBtn) els.clearMaturityBtn.addEventListener('click', clearMaturityData);

        function openMaturityWizard() {
            if (!els.maturityWizard || !els.maturityWizardContent) return;
            els.maturityWizard.classList.remove('hidden');
            maturityWizardQuestions = [];
            maturityWizardIndex = 0;
            maturityWizardSelections = {};
            if (els.maturityWizardLLM) els.maturityWizardLLM.textContent = '';
            if (els.maturityWizardSubtitle) els.maturityWizardSubtitle.textContent = 'Precheck tamamlandƒ±. Eksik/≈ü√ºpheli kriterler i√ßin hƒ±zlƒ± sorular.';
            renderMaturityWizard();
        }

        function closeMaturityWizard() {
            if (!els.maturityWizard) return;
            els.maturityWizard.classList.add('hidden');
        }

        async function generateMaturityWizardQuestions() {
            if (!els.maturityWizardContent) return;
            els.maturityWizardContent.innerHTML = `<div class="maturity-muted">Sorular hazƒ±rlanƒ±yor...</div>`;
            try {
                persistLLMSettings();
                const body = {
                    maxQuestions: 20,
                    minConfidence: 0.6,
                    userNotes: (els.maturityNotes?.value || '').trim(),
                    answers: maturityAnswers || {},
                    llm: buildLLMConfig()
                };
                const resp = await requestJSON(`/api/maturity/questions?cluster=${encodeURIComponent(state.cluster)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                maturityWizardQuestions = Array.isArray(resp.questions) ? resp.questions : [];
                maturityWizardIndex = 0;
                if (els.maturityWizardLLM) {
                    els.maturityWizardLLM.textContent = resp.llm
                        ? `LLM: ${resp.llm.provider}${resp.llm.model ? ' / ' + resp.llm.model : ''}`
                        : (resp.note ? String(resp.note) : '');
                }
                renderMaturityWizard();
            } catch (e) {
                els.maturityWizardContent.innerHTML = `<div class="maturity-muted">Sorular olu≈üturulamadƒ±: ${escapeHTML(e.message)}<br/>Devam edip manuel cevap girebilirsiniz.</div>`;
            }
        }

        function renderMaturityWizard() {
            if (!els.maturityWizardContent) return;
            const total = maturityWizardQuestions.length;
            if (els.maturityWizardPrev) els.maturityWizardPrev.disabled = maturityWizardIndex <= 0;
            if (els.maturityWizardNext) els.maturityWizardNext.classList.toggle('hidden', total === 0 || maturityWizardIndex >= total - 1);
            if (els.maturityWizardRun) els.maturityWizardRun.classList.toggle('hidden', total === 0 || maturityWizardIndex < total - 1);
            if (els.maturityWizardProgress) {
                els.maturityWizardProgress.textContent = total ? `${maturityWizardIndex + 1}/${total}` : '0/0';
            }

            if (!total) {
                if (els.maturityWizardNext) els.maturityWizardNext.disabled = true;
                if (els.maturityWizardRun) els.maturityWizardRun.disabled = true;
                els.maturityWizardContent.innerHTML = `
                    <div class="maturity-muted">Hen√ºz soru yok. ‚ÄúSorularƒ± Olu≈ütur‚Äù ile devam edin veya ‚ÄúAtla‚Äù ile rapor olu≈üturun.</div>
                `;
                return;
            }

            const q = maturityWizardQuestions[maturityWizardIndex];
            const selected = maturityWizardSelections[q.key] || {};
            const choice = selected.choice || '';
            const note = selected.note || '';
            const choices = Array.isArray(q.choices) && q.choices.length ? q.choices : ['L1','L2','L3','L4','L5','Bilmiyorum'];
            const hints = Array.isArray(q.hints) ? q.hints : [];

            if (els.maturityWizardNext) els.maturityWizardNext.disabled = !choice;
            if (els.maturityWizardRun) els.maturityWizardRun.disabled = !choice;

            els.maturityWizardContent.innerHTML = `
                <div class="maturity-wizard-question-title">${escapeHTML(q.category || '')}</div>
                <div class="maturity-wizard-question-title">${escapeHTML(q.criterion || '')}</div>
                <div class="maturity-wizard-question-text">${escapeHTML(q.question || '')}</div>
                ${hints.length ? `
                    <ul class="maturity-details-list">
                        ${hints.slice(0, 6).map(h => `<li>${escapeHTML(h)}</li>`).join('')}
                    </ul>
                ` : ``}
                <div class="maturity-wizard-choices">
                    ${choices.map(c => `<button type="button" class="maturity-choice ${c === choice ? 'selected' : ''}" data-choice="${escapeHTML(c)}">${escapeHTML(c)}</button>`).join('')}
                </div>
                <textarea class="maturity-wizard-note" id="maturityWizardNote" placeholder="Opsiyonel: kƒ±sa kanƒ±t / link / komut √ßƒ±ktƒ±sƒ±...">${escapeHTML(note)}</textarea>
            `;

            els.maturityWizardContent.querySelectorAll('[data-choice]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const c = btn.getAttribute('data-choice') || '';
                    maturityWizardSelections[q.key] = { ...(maturityWizardSelections[q.key] || {}), choice: c };
                    renderMaturityWizard();
                });
            });
        }

        function persistWizardAnswer() {
            const total = maturityWizardQuestions.length;
            if (!total) return;
            const q = maturityWizardQuestions[maturityWizardIndex];
            const selected = maturityWizardSelections[q.key] || {};
            const noteEl = document.getElementById('maturityWizardNote');
            const note = noteEl ? String(noteEl.value || '').trim() : (selected.note || '');
            maturityWizardSelections[q.key] = { ...selected, note };

            const choice = String((maturityWizardSelections[q.key] || {}).choice || '').trim();
            if (!choice) return;
            const merged = note ? `${choice} ‚Äî ${note}` : choice;
            if (!maturityAnswers) maturityAnswers = {};
            maturityAnswers[q.key] = merged;
            persistMaturityAnswers();
        }

        async function runFinalAnalysisFromWizard() {
            persistWizardAnswer();
            closeMaturityWizard();
            if (!els.maturityStatus) return;
            els.maturityStatus.textContent = 'Collecting evidence + analyzing...';
            els.maturityStatus.classList.remove('error', 'success');
            try {
                persistLLMSettings();
                const body = {
                    userNotes: (els.maturityNotes?.value || '').trim(),
                    answers: maturityAnswers || {},
                    llm: buildLLMConfig()
                };
                const report = await requestJSON(`/api/maturity/analyze?cluster=${encodeURIComponent(state.cluster)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                maturityLastReport = report;
                els.maturityStatus.textContent = report.llm
                    ? `Done (LLM: ${report.llm.provider}${report.llm.model ? ' / ' + report.llm.model : ''}).`
                    : 'Done.';
                els.maturityStatus.classList.add('success');
                renderMaturityUI(maturityCriteriaDoc, maturityLastReport);
            } catch (e) {
                els.maturityStatus.textContent = `Analysis failed: ${e.message}`;
                els.maturityStatus.classList.add('error');
            }
        }

        if (els.maturityWizardClose) els.maturityWizardClose.addEventListener('click', closeMaturityWizard);
        if (els.maturityWizardGenerate) els.maturityWizardGenerate.addEventListener('click', generateMaturityWizardQuestions);
        if (els.maturityWizardSkip) els.maturityWizardSkip.addEventListener('click', runFinalAnalysisFromWizard);
        if (els.maturityWizardPrev) els.maturityWizardPrev.addEventListener('click', () => {
            persistWizardAnswer();
            maturityWizardIndex = Math.max(0, maturityWizardIndex - 1);
            renderMaturityWizard();
        });
        if (els.maturityWizardNext) els.maturityWizardNext.addEventListener('click', () => {
            persistWizardAnswer();
            maturityWizardIndex = Math.min(maturityWizardQuestions.length - 1, maturityWizardIndex + 1);
            renderMaturityWizard();
        });
        if (els.maturityWizardRun) els.maturityWizardRun.addEventListener('click', runFinalAnalysisFromWizard);

        function persistLLMSettings() {
            try {
                const provider = (els.llmProvider?.value || 'auto').trim();
                const model = (els.llmModel?.value || '').trim();
                localStorage.setItem('kubeapp.llm.provider', provider);
                localStorage.setItem('kubeapp.llm.model', model);
            } catch (_) { }
        }

        function restoreLLMSettings() {
            try {
                const provider = localStorage.getItem('kubeapp.llm.provider') || 'auto';
                const model = localStorage.getItem('kubeapp.llm.model') || '';
                if (els.llmProvider) els.llmProvider.value = provider;
                if (els.llmModel) els.llmModel.value = model;
            } catch (_) { }
        }

        // Upload kubeconfig
        els.uploadBtn.addEventListener('click', async () => {
            const file = els.kubeconfigFile.files[0];
            if (!file) {
                els.uploadStatus.textContent = 'Please choose a kubeconfig file.';
                els.uploadStatus.classList.remove('success');
                els.uploadStatus.classList.add('error');
                return;
            }
            els.uploadStatus.textContent = 'Uploading...';
            els.uploadStatus.classList.remove('success', 'error');

            try {
                const fd = new FormData();
                fd.append('kubeconfig', file);
                const name = (els.kubeconfigName.value || '').trim();
                const context = (els.kubeconfigContext.value || '').trim();
                if (name) fd.append('name', name);
                if (context) fd.append('context', context);
                if (els.kubeconfigInsecure && els.kubeconfigInsecure.checked) fd.append('insecure', 'true');

                const res = await fetch('/api/cluster/upload', { method: 'POST', body: fd });
                const text = await res.text();
                if (!res.ok) throw new Error(text);
                const data = JSON.parse(text);
                els.uploadStatus.textContent = `Connected as "${data.name}" (context: ${data.context})`;
                els.uploadStatus.classList.remove('error');
                els.uploadStatus.classList.add('success');

                // Refresh clusters and switch to the new one
                await fetchClusters();
                els.clusterSelect.value = data.name;
                state.cluster = data.name;
                await fetchNamespaces();
                refreshAll();
                updateBreadcrumbs();

                // Clear file input and label so alignment reset
                els.kubeconfigFile.value = '';
                refreshKubeconfigFileLabel();
            } catch (e) {
                els.uploadStatus.textContent = `Error: ${e.message}`;
                els.uploadStatus.classList.remove('success');
                els.uploadStatus.classList.add('error');
            }
        });

        // === Detail Panel Functions ===
        let currentResource = null;
        let originalContent = '';

        async function openResourceDetail(type, name, namespace) {
            currentResource = { type, name, namespace };
            const panel = document.getElementById('detailPanel');
            const title = document.getElementById('detailTitle');
            const treeView = document.getElementById('jsonTreeView');
            const editor = document.getElementById('resourceEditor');

            title.textContent = `${type.toUpperCase()}: ${name}`;
            treeView.innerHTML = '<div style="color:#94a3b8;">Loading...</div>';
            treeView.classList.remove('hidden');
            editor.classList.add('hidden');

            // Show panel
            panel.classList.remove('hidden');
            setTimeout(() => panel.classList.add('open'), 10);

            // Reset buttons
            document.getElementById('editBtn').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');

            try {
                const res = await fetch(`/api/resource/yaml?type=${encodeURIComponent(type)}&name=${encodeURIComponent(name)}&namespace=${encodeURIComponent(namespace)}&cluster=${encodeURIComponent(state.cluster)}`);
                const payload = await res.text();
                if (!res.ok) {
                    let message = payload;
                    try {
                        const data = JSON.parse(payload);
                        if (data && data.message) message = data.message;
                    } catch (err) {
                        // keep raw payload
                    }
                    throw new Error(message || 'Failed to fetch resource');
                }
                let jsonData;
                try {
                    jsonData = JSON.parse(payload);
                } catch (parseErr) {
                    throw new Error(`Invalid resource payload: ${parseErr.message}`);
                }
                originalContent = payload;
                editor.value = payload;

                // Render JSON tree
                treeView.innerHTML = '';
                treeView.appendChild(renderJsonTree(jsonData, 0, true));
            } catch (e) {
                treeView.innerHTML = `<div style="color:#ef4444;">Error: ${e.message}</div>`;
            }
        }

        // JSON Tree Renderer with collapsible sections
        function renderJsonTree(data, depth = 0, expanded = true) {
            const container = document.createElement('div');

            if (data === null) {
                container.innerHTML = '<span class="json-null">null</span>';
                return container;
            }

            if (typeof data === 'string') {
                container.innerHTML = `<span class="json-string">"${escapeHtml(data)}"</span>`;
                return container;
            }

            if (typeof data === 'number') {
                container.innerHTML = `<span class="json-number">${data}</span>`;
                return container;
            }

            if (typeof data === 'boolean') {
                container.innerHTML = `<span class="json-boolean">${data}</span>`;
                return container;
            }

            if (Array.isArray(data)) {
                const wrapper = document.createElement('div');
                wrapper.className = data.length > 0 ? (expanded ? 'json-expanded' : 'json-collapsed') : '';

                if (data.length > 0) {
                    const toggle = document.createElement('span');
                    toggle.className = 'json-toggle';
                    toggle.onclick = () => wrapper.classList.toggle('json-collapsed') || wrapper.classList.toggle('json-expanded');
                    wrapper.appendChild(toggle);
                }

                const bracket = document.createElement('span');
                bracket.className = 'json-bracket';
                bracket.textContent = `[ ${data.length} items ]`;
                wrapper.appendChild(bracket);

                if (data.length > 0) {
                    const children = document.createElement('div');
                    children.className = 'json-children';
                    data.forEach((item, i) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'json-item';
                        itemDiv.appendChild(renderJsonTree(item, depth + 1, depth < 1));
                        if (i < data.length - 1) {
                            const comma = document.createElement('span');
                            comma.className = 'json-bracket';
                            comma.textContent = ',';
                            itemDiv.appendChild(comma);
                        }
                        children.appendChild(itemDiv);
                    });
                    wrapper.appendChild(children);
                }

                return wrapper;
            }

            // Object
            const keys = Object.keys(data);
            const wrapper = document.createElement('div');

            // Collapse managedFields and status by default at depth 1
            const shouldCollapse = depth === 1 && ['managedFields', 'status', 'annotations'].some(k => keys.includes(k));
            wrapper.className = keys.length > 0 ? (expanded && !shouldCollapse ? 'json-expanded' : 'json-collapsed') : '';

            if (keys.length > 0) {
                const toggle = document.createElement('span');
                toggle.className = 'json-toggle';
                toggle.onclick = () => wrapper.classList.toggle('json-collapsed') || wrapper.classList.toggle('json-expanded');
                wrapper.appendChild(toggle);
            }

            const bracket = document.createElement('span');
            bracket.className = 'json-bracket';
            bracket.textContent = `{ ${keys.length} keys }`;
            wrapper.appendChild(bracket);

            if (keys.length > 0) {
                const children = document.createElement('div');
                children.className = 'json-children';
                keys.forEach((key, i) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'json-item';

                    const keySpan = document.createElement('span');
                    keySpan.className = 'json-key';
                    keySpan.textContent = `"${key}"`;
                    itemDiv.appendChild(keySpan);

                    const colon = document.createTextNode(': ');
                    itemDiv.appendChild(colon);

                    // Collapse certain keys by default
                    const collapseKeys = ['managedFields', 'annotations', 'ownerReferences', 'finalizers'];
                    const shouldCollapseChild = collapseKeys.includes(key);
                    itemDiv.appendChild(renderJsonTree(data[key], depth + 1, !shouldCollapseChild && depth < 2));

                    if (i < keys.length - 1) {
                        const comma = document.createElement('span');
                        comma.className = 'json-bracket';
                        comma.textContent = ',';
                        itemDiv.appendChild(comma);
                    }
                    children.appendChild(itemDiv);
                });
                wrapper.appendChild(children);
            }

            return wrapper;
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function expandAll() {
            document.querySelectorAll('.json-collapsed').forEach(el => {
                el.classList.remove('json-collapsed');
                el.classList.add('json-expanded');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.json-expanded').forEach(el => {
                el.classList.remove('json-expanded');
                el.classList.add('json-collapsed');
            });
        }

        function closeDetailPanel() {
            const panel = document.getElementById('detailPanel');
            panel.classList.remove('open');
            setTimeout(() => panel.classList.add('hidden'), 300);
            currentResource = null;
        }

        function toggleEditMode() {
            const editor = document.getElementById('resourceEditor');
            const treeView = document.getElementById('jsonTreeView');

            // Switch from tree view to textarea editor
            treeView.classList.add('hidden');
            editor.classList.remove('hidden');
            editor.readOnly = false;

            // Pretty print the JSON for editing
            try {
                const data = JSON.parse(originalContent);
                editor.value = JSON.stringify(data, null, 2);
            } catch (e) {
                editor.value = originalContent;
            }

            document.getElementById('editBtn').classList.add('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            document.getElementById('expandAllBtn').classList.add('hidden');
            document.getElementById('collapseAllBtn').classList.add('hidden');
        }

        function cancelEdit() {
            const editor = document.getElementById('resourceEditor');
            const treeView = document.getElementById('jsonTreeView');

            // Switch back to tree view
            editor.classList.add('hidden');
            treeView.classList.remove('hidden');
            editor.value = originalContent;

            document.getElementById('editBtn').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('expandAllBtn').classList.remove('hidden');
            document.getElementById('collapseAllBtn').classList.remove('hidden');
        }

        async function saveResource() {
            const editor = document.getElementById('resourceEditor');
            const content = editor.value;

            try {
                const res = await fetch('/api/resource/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...currentResource,
                        content: content,
                        cluster: state.cluster
                    })
                });
                const result = await res.json();

                if (result.status === 'success') {
                    alert('Resource updated successfully!');
                    originalContent = content;
                    cancelEdit();
                    refreshAll();
                } else {
                    alert('Update failed: ' + (result.message || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // === Create Resource Preview ===
        let createPreviewCy = null;

        function initCreatePreview() {
            if (createPreviewCy) createPreviewCy.destroy();

            createPreviewCy = cytoscape({
                container: document.getElementById('createPreviewCy'),
                elements: [],
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'background-color': 'data(color)',
                            'color': '#fff',
                            'font-size': '12px',
                            'width': 120,
                            'height': 60,
                            'shape': 'roundrectangle',
                            'text-wrap': 'wrap',
                            'text-max-width': '100px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#64748b',
                            'target-arrow-color': '#64748b',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    }
                ],
                layout: { name: 'preset' }
            });

            updateCreatePreview();
        }

        function updateCreatePreview() {
            if (!createPreviewCy) return;

            const name = document.getElementById('createWorkloadName').value || 'my-app';
            const type = document.getElementById('createWorkloadType').value;
            const serviceEnabled = document.getElementById('createServiceEnabled').checked;
            const ingressEnabled = document.getElementById('createIngressEnabled').checked;
            const configMapEnabled = document.getElementById('createConfigMapEnabled').checked;
            const secretEnabled = document.getElementById('createSecretEnabled').checked;
            const pvcEnabled = document.getElementById('createPVCEnabled').checked;
            const resourcesEnabled = document.getElementById('createResourcesEnabled').checked;

            // Toggle field visibility
            document.getElementById('serviceFields').classList.toggle('hidden', !serviceEnabled);
            document.getElementById('ingressFields').classList.toggle('hidden', !ingressEnabled);
            document.getElementById('configMapFields').classList.toggle('hidden', !configMapEnabled);
            document.getElementById('secretFields').classList.toggle('hidden', !secretEnabled);
            document.getElementById('pvcFields').classList.toggle('hidden', !pvcEnabled);
            document.getElementById('resourceLimitsFields').classList.toggle('hidden', !resourcesEnabled);

            // Build elements
            const nodes = [];
            const edges = [];
            let x = 300, y = 150;

            // Workload node
            const workloadId = type + '-' + name;
            const typeIcons = { deployment: 'üì¶', statefulset: 'üóÑÔ∏è', daemonset: 'üîÑ' };
            nodes.push({
                data: { id: workloadId, label: `${typeIcons[type]} ${type.toUpperCase()}\n${name}`, color: '#3b82f6' },
                position: { x, y }
            });

            // Service
            if (serviceEnabled) {
                const svcId = 'svc-' + name;
                nodes.push({
                    data: { id: svcId, label: `‚ö° SERVICE\n${name}-svc`, color: '#8b5cf6' },
                    position: { x: x - 180, y }
                });
                edges.push({ data: { source: svcId, target: workloadId } });
            }

            // Ingress
            if (ingressEnabled && serviceEnabled) {
                const ingressId = 'ing-' + name;
                const host = document.getElementById('createIngressHost').value || 'app.example.com';
                nodes.push({
                    data: { id: ingressId, label: `üåê INGRESS\n${host}`, color: '#06b6d4' },
                    position: { x: x - 360, y }
                });
                edges.push({ data: { source: ingressId, target: 'svc-' + name } });
            }

            // ConfigMap
            if (configMapEnabled) {
                const cmId = 'cm-' + name;
                nodes.push({
                    data: { id: cmId, label: `üìù CONFIGMAP\n${name}-config`, color: '#10b981' },
                    position: { x: x - 100, y: y + 120 }
                });
                edges.push({ data: { source: workloadId, target: cmId } });
            }

            // Secret
            if (secretEnabled) {
                const secretId = 'secret-' + name;
                nodes.push({
                    data: { id: secretId, label: `üîê SECRET\n${name}-secret`, color: '#f59e0b' },
                    position: { x, y: y + 120 }
                });
                edges.push({ data: { source: workloadId, target: secretId } });
            }

            // PVC
            if (pvcEnabled) {
                const pvcId = 'pvc-' + name;
                nodes.push({
                    data: { id: pvcId, label: `üíæ PVC\n${name}-pvc`, color: '#ec4899' },
                    position: { x: x + 100, y: y + 120 }
                });
                edges.push({ data: { source: workloadId, target: pvcId } });
            }

            createPreviewCy.elements().remove();
            createPreviewCy.add([...nodes, ...edges]);
            createPreviewCy.fit(createPreviewCy.elements(), 50);
        }

        // Add Environment Variable row
        function addEnvVar() {
            const list = document.getElementById('envVarsList');
            const row = document.createElement('div');
            row.className = 'env-var-row';
            row.innerHTML = `
                <input type="text" placeholder="KEY" class="env-key">
                <input type="text" placeholder="value" class="env-value">
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            list.appendChild(row);
        }

        // Get all env vars from form
        function getEnvVars() {
            const rows = document.querySelectorAll('.env-var-row');
            const envVars = [];
            rows.forEach(row => {
                const key = row.querySelector('.env-key').value;
                const value = row.querySelector('.env-value').value;
                if (key) envVars.push({ name: key, value: value || '' });
            });
            return envVars;
        }

        async function deployResources() {
            const name = document.getElementById('createWorkloadName').value;
            if (!name) {
                alert('Please enter a workload name');
                return;
            }

            const config = {
                type: document.getElementById('createWorkloadType').value,
                name: name,
                replicas: parseInt(document.getElementById('createReplicas').value) || 1,
                containerName: document.getElementById('createContainerName').value || 'main',
                image: document.getElementById('createImage').value || 'nginx:latest',
                containerPort: parseInt(document.getElementById('createContainerPort').value) || 80,
                namespace: state.namespace,
                cluster: state.cluster,
                envVars: getEnvVars(),
                resources: document.getElementById('createResourcesEnabled').checked ? {
                    cpuRequest: document.getElementById('createCpuRequest').value || '100m',
                    cpuLimit: document.getElementById('createCpuLimit').value || '500m',
                    memRequest: document.getElementById('createMemRequest').value || '128Mi',
                    memLimit: document.getElementById('createMemLimit').value || '512Mi'
                } : null,
                service: document.getElementById('createServiceEnabled').checked ? {
                    type: document.getElementById('createServiceType').value,
                    port: parseInt(document.getElementById('createServicePort').value) || 80
                } : null,
                ingress: document.getElementById('createIngressEnabled').checked ? {
                    host: document.getElementById('createIngressHost').value || '',
                    path: document.getElementById('createIngressPath').value || '/',
                    pathType: document.getElementById('createIngressPathType').value
                } : null,
                configMap: document.getElementById('createConfigMapEnabled').checked ? {
                    usage: document.getElementById('createConfigMapUsage').value,
                    mountPath: document.getElementById('createConfigMapPath').value || '/etc/config'
                } : null,
                secret: document.getElementById('createSecretEnabled').checked ? {
                    usage: document.getElementById('createSecretUsage').value,
                    mountPath: document.getElementById('createSecretPath').value || '/etc/secrets'
                } : null,
                pvc: document.getElementById('createPVCEnabled').checked ? {
                    size: document.getElementById('createPVCSize').value || '1Gi',
                    accessMode: document.getElementById('createPVCAccessMode').value,
                    mountPath: document.getElementById('createPVCPath').value || '/data'
                } : null
            };

            try {
                const res = await fetch('/api/resource/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const result = await res.json();

                if (result.status === 'success') {
                    alert('Resources deployed successfully! üöÄ');
                    // Switch to topology view
                    document.querySelector('.topology-nav').click();
                } else {
                    alert('Deploy failed: ' + (result.message || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        init();
    </script>
</body>

</html>
